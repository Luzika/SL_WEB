{% load url_tags %}
{% load static %}

<div class="container-fluid py-4 shipmentBox">
  <h1 class="display-5 fw-bold text-primary mb-5 shipmentFormHeader">
    <i class="bi bi-list-ul me-2"></i>Shipment List
  </h1>

  <div class="table-responsive" style="position: relative;">
    <table id="shipmentTable" class="table table-bordered table-hover mb-0" style="border-radius: 0.5rem; overflow: hidden; position: relative; min-width: 100%;">
      <thead>
        <tr class="table-primary">
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">SHIPMENT ID</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">COMPANY</th>
          <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">VESSEL</th>
          <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">DOC</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 50px; font-size: 0.65rem;">Ask.No</th>
          <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">Po.No</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">SUPPLIER</th>
          <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">C.PACKING</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 25px; font-size: 0.65rem;">QTY</th>
          <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 25px; font-size: 0.65rem;">UNIT</th>
          <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">SIZE</th>
          <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">WEIGHT</th>
          <th scope="col" class="shipmentTableTh" style="width: 0; min-width: 0; font-size: 0.65rem; display: none;"></th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 50px; font-size: 0.65rem;">IN</th>
          <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 25px; font-size: 0.65rem;">W/H</th>
          <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 25px; font-size: 0.65rem;">BY</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 30px; font-size: 0.65rem;">BLNO</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 30px; font-size: 0.65rem;">PORT</th>
          <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">ONBOARD DATE</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 30px; font-size: 0.65rem;">REMARK</th>
          <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 60px; font-size: 0.65rem;">MEMO</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 60px; font-size: 0.65rem;">JOB NO</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 30px; font-size: 0.65rem;">STATUS</th>
          <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">IMAGE</th>
        </tr>
        <tr>
          <th id="totalRow" colspan="24" class="text-end fw-bold py-2" style="width: 100%; background-color: #e9ecef;">
            TOTAL: {{ totalResults }}
          </th>
        </tr>
      </thead>
      <tbody>
        {% for shipment in shipmentPage %}
          <tr>
            <td class="shipmentTableTd">
              <a href="{% url 'customerTracking' %}?shipment_id={{ shipment.shipment_id }}" class="shipment-id-link" data-colordiv="{{ shipment.colordiv }}">
                {{ shipment.shipment_id }}
              </a>
            </td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.company }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.vessel }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.docs }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.ASKno|default_if_none:'' }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.POno|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.supplier }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.c_packing }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.quanty|floatformat:0 }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.unit }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.size|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.weight }}</td>
            <td style="display: none; color: {{ shipment.colordiv }};">{{ shipment.division }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.in_date|date:"Ymd" }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.warehouse }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.by }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.BLno }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.port }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.out_date|date:"Ymd"|default_if_none:'' }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.remark|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.memo }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.job_number }}</td>
            {% if shipment.flag_status %}
                <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.flag_status }}</td>
            {% else %}
                <td></td>
            {% endif %}
            <td>
              {% if shipment.image %}
              <a href="{{ shipment.image.url }}" target="_blank">
                <img src="{{ shipment.image.url }}" class="img-fluid linked-image">
              </a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end mt-4 me-4">
    <nav aria-label="Page navigation">
      <div class="d-flex align-items-center">
        <label for="pageSelect" class="me-2" style="font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
          Page:
        </label>
        <select id="pageSelect" name="pageSelect" class="form-select" style="width: auto; font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
          {% for num in shipmentPage.paginator.page_range %}
            <option value="{{ num }}" {% if num == shipmentPage.number %}selected{% endif %}>
              {{ num }} of {{ shipmentPage.paginator.num_pages }}
            </option>
          {% endfor %}
        </select>
      </div>
    </nav>
  </div>
</div>

<style>
  #shipmentTable tbody tr:nth-child(odd) td {
    background-color: #f8f9fa !important;
  }
  #shipmentTable tbody tr:nth-child(even) td {
    background-color: #e9ecef !important;
  }
  #shipmentTable.table-hover tbody tr:hover td {
    background-color: #d1ecf1 !important;
  }
  #shipmentTable td:nth-child(9) {
    white-space: pre-wrap;
  }
  #shipmentTable td:nth-child(21) img.status-image {
    max-width: 2rem;
    max-height: 2rem;
    user-select: none;
  }
  #shipmentTable td:nth-child(22) img.linked-image {
    max-width: 4rem;
    max-height: 3rem;
    user-select: none;
  }
  .resize-bar {
    position: absolute;
    top: 0;
    width: 10px;
    height: 100%;
    cursor: col-resize;
    z-index: 10;
    background: transparent;
    user-select: none;
  }
  .resize-bar:hover {
    background: rgba(0, 0, 0, 0.2);
  }
  #shipmentTable th, #shipmentTable td {
    border-right: 1px solid #dee2e6;
    position: relative;
    user-select: text;
  }
  .shipmentTableTd {
    user-select: text;
  }
  .shipment-id-link {
    user-select: text;
    display: inline-block;
    text-decoration: underline;
    transition: transform 0.2s ease, color 0.2s ease, background-color 0.2s ease;
    padding: 2px 4px;
    border-radius: 3px;
  }
  .shipment-id-link:hover {
    transform: scale(1.05);
    color: #0056b3 !important;
    background-color: rgba(0, 123, 255, 0.1);
    cursor: pointer;
  }
  .form-select {
    border-color: #007bff;
    color: #007bff;
  }
  .form-select:focus {
    border-color: #0056b3;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  .table-responsive {
    overflow-x: auto;
    overflow-y: hidden;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('shipmentTable');
    const container = table.parentElement;
    const headers = table.querySelectorAll('th:not([style*="display: none"])');
    const totalRow = document.getElementById('totalRow');

    // Table resizing and scrolling
    const adjustContainerHeight = () => {
      const tableHeight = table.offsetHeight;
      container.style.minHeight = `${tableHeight}px`;
    };
    adjustContainerHeight();

    const initialWidths = [];
    headers.forEach(th => {
      const width = th.offsetWidth;
      th.style.width = `${width}px`;
      initialWidths.push(width);
    });

    totalRow.style.width = `${table.offsetWidth}px`;

    const bars = [];
    headers.forEach((th, index) => {
      const bar = document.createElement('div');
      bar.className = 'resize-bar';
      let leftPos = 0;
      for (let i = 0; i < index; i++) {
        leftPos += headers[i].offsetWidth;
      }
      bar.style.left = `${leftPos + th.offsetWidth - 5}px`;
      container.appendChild(bar);
      bars.push(bar);

      let startX, startWidth, initialTableWidth;
      const startDraggingResize = (e) => {
        startX = e.pageX;
        startWidth = th.offsetWidth;
        initialTableWidth = table.offsetWidth;
        document.addEventListener('mousemove', doDraggingResize);
        document.addEventListener('mouseup', stopDraggingResize);
      };

      const doDraggingResize = (e) => {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth >= parseInt(th.style.minWidth)) {
          th.style.width = `${newWidth}px`;
          const newTableWidth = initialTableWidth + (newWidth - startWidth);
          table.style.width = `${newTableWidth}px`;
          totalRow.style.width = `${newTableWidth}px`;
          bar.style.left = `${leftPos + newWidth - 5}px`;
          updateBarPositions();
          adjustContainerHeight();
        }
      };

      const stopDraggingResize = () => {
        document.removeEventListener('mousemove', doDraggingResize);
        document.removeEventListener('mouseup', stopDraggingResize);
      };

      bar.addEventListener('mousedown', startDraggingResize);
    });

    const updateBarPositions = () => {
      let leftPos = 0;
      headers.forEach((th, index) => {
        leftPos += th.offsetWidth;
        bars[index].style.left = `${leftPos - 5}px`;
      });
    };

    const updateBarHeight = () => {
      const tableHeight = table.offsetHeight;
      bars.forEach(bar => {
        bar.style.height = `${tableHeight}px`;
      });
      adjustContainerHeight();
    };
    updateBarHeight();

    window.addEventListener('resize', () => {
      updateBarHeight();
      updateBarPositions();
      totalRow.style.width = `${table.offsetWidth}px`;
      adjustContainerHeight();
    });

    let isDraggingScroll = false;
    let startXScroll;
    let scrollLeft;
    let animationFrameId;
    let isSelectingText = false;

    const smoothScroll = (targetScroll) => {
      const currentScroll = container.scrollLeft;
      const delta = targetScroll - currentScroll;
      const step = delta * 0.05;
      container.scrollLeft += step;
      if (Math.abs(delta) > 0.5) {
        animationFrameId = requestAnimationFrame(() => smoothScroll(targetScroll));
      } else {
        container.scrollLeft = targetScroll;
        cancelAnimationFrame(animationFrameId);
      }
    };

    container.addEventListener('mousedown', (e) => {
      if (!e.target.classList.contains('resize-bar')) {
        startXScroll = e.pageX;
        scrollLeft = container.scrollLeft;
        isSelectingText = false;
        // Delay to check if user is selecting text or dragging
        setTimeout(() => {
          if (!isSelectingText && Math.abs(e.pageX - startXScroll) > 5) {
            isDraggingScroll = true;
            container.style.cursor = 'grabbing';
            container.style.userSelect = 'none';
          }
        }, 100);
      }
    });

    container.addEventListener('mousemove', (e) => {
      if (isDraggingScroll) {
        const x = e.pageX;
        const walk = (startXScroll - x);
        const targetScroll = scrollLeft + walk;
        cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(() => smoothScroll(targetScroll));
      }
    });

    container.addEventListener('mouseup', () => {
      isDraggingScroll = false;
      container.style.cursor = 'default';
      container.style.userSelect = 'text';
      cancelAnimationFrame(animationFrameId);
    });

    container.addEventListener('mouseleave', () => {
      isDraggingScroll = false;
      container.style.cursor = 'default';
      container.style.userSelect = 'text';
      cancelAnimationFrame(animationFrameId);
    });

    container.addEventListener('wheel', (e) => {
      if (Math.abs(e.deltaX) > 0) {
        container.scrollLeft += e.deltaX;
        e.preventDefault();
      }
    });

    // Detect text selection
    document.addEventListener('selectionchange', () => {
      const selection = window.getSelection();
      if (selection.toString().length > 0) {
        isSelectingText = true;
      }
    });

    // Prevent link navigation during text selection
    const shipmentLinks = document.querySelectorAll('.shipment-id-link');
    shipmentLinks.forEach(link => {
      link.addEventListener('mousedown', (e) => {
        const selection = window.getSelection();
        if (selection.toString().length > 0 || isSelectingText) {
          e.preventDefault();
        }
      });
      link.addEventListener('click', (e) => {
        const selection = window.getSelection();
        if (selection.toString().length > 0) {
          e.preventDefault();
        }
      });
    });

    const pageSelect = document.getElementById('pageSelect');
    if (pageSelect) {
      pageSelect.addEventListener('change', (e) => {
        const selectedPage = e.target.value;
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        params.set('page', selectedPage);
        url.search = params.toString();
        window.location.href = url.toString();
      });
    }

    const resizeObserver = new ResizeObserver(() => {
      updateBarHeight();
      updateBarPositions();
      totalRow.style.width = `${table.offsetWidth}px`;
      adjustContainerHeight();
    });
    resizeObserver.observe(table);

    const images = container.querySelectorAll('img');
    images.forEach(img => {
      img.addEventListener('dragstart', (e) => e.preventDefault());
    });
  });
</script>