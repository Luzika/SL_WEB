{% load url_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Distribution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles_shipmentList_customer.css' %}">
</head>
<body>
    <div class="main-container">
        <h1 class="display-5 fw-bold text-primary mb-5 shipmentFormHeader">
            <i class="bi bi-list-ul me-2"></i>Shipment List
        </h1>

    <div class="d-flex align-items-center flex-wrap justify-content-between gap-3 mb-3" style="padding: 1.5rem; background-color: #ffffff; border: 1px solid #c0c0c0; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
        <div class="d-flex align-items-center gap-3">
            <div class="total-rows">
                Total Rows: <span>{{ totalResults }}</span>
            </div>
            <div class="total-count">
                Total Ticked: <span id="totalTicked">0</span>
            </div>
        </div>

        <div class="d-flex align-items-center gap-3">
            <nav aria-label="Page navigation">
                <form id="pageSelectForm" method="GET" action="">
                    {% csrf_token %}

                    <!-- Preserve all existing GET parameters as hidden inputs -->
                    {% for key, value in request.GET.items %}
                        {% if key != 'page' and key != 'csrfmiddlewaretoken' %}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}

                    <!-- If there are multiple values for the same key (rare, but possible with range filters) -->
                    {% for key, value_list in request.GET.lists %}
                        {% if key != 'page' and key != 'csrfmiddlewaretoken' %}
                            {% for value in value_list %}
                                {% if value %}
                                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}

                    <div class="d-flex align-items-center">
                        <label for="pageSelect" class="me-2">Page:</label>
                        <select id="pageSelect" name="page" class="form-select" style="width: auto; font-family: 'Poppins', sans-serif; font-size: 0.9rem;" onchange="this.form.submit()">
                            {% for num in shipmentPage.paginator.page_range %}
                                <option value="{{ num }}" {% if num == shipmentPage.number %}selected{% endif %}>
                                    {{ num }} of {{ shipmentPage.paginator.num_pages }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </nav>
            <button class="action-button" id="selectAllDataBtn" type="button">
                <i class="bi bi-check-square-fill"></i> Select All Data
            </button>
            <button class="action-button flex-fill" id="exportBtn" type="button">
                <i class="bi bi-file-earmark-excel"></i> Export Selected
            </button>
            <button type="button" class="action-button flex-fill" id="resetSortBtn">
                <i class="bi bi-arrow-counterclockwise"></i> Reset Sort
            </button>
            <button id="fullScreenBtn" class="action-button" type="button">
                <i class="bi bi-arrows-fullscreen"></i> Full screen
            </button>
        </div>
    </div>
        <div class="table-container" id="shipmentTableContainer">
            <form method="post" id="shipmentForm">
                {% csrf_token %}
                <table id="shipmentTable" class="main-table table table-striped table-bordered table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="resizable" style="width: 40px;background-color: #cfe2ff;">
                                <input type="checkbox" class="form-check-input" id="id_selectall">
                            </th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="shipment_id"><span class="header-title">Shipment ID</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="company"><span class="header-title">Company</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="vessel"><span class="header-title">Vessel</span></th>
                            <!-- <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="docs"><span class="header-title">DOC</span></th> -->
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="Order_No"><span class="header-title">Order No</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="supplier"><span class="header-title">Supplier</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="c_packing"><span class="header-title">C.Packing</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="quanty"><span class="header-title">QTY</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="unit"><span class="header-title">Unit</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="size"><span class="header-title">Size</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="weight"><span class="header-title">Weight</span></th>
                            <th style="display: none;">Division</th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="in_date"><span class="header-title">In</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="warehouse"><span class="header-title">W/H</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="by"><span class="header-title">By</span></th>
                            <!-- <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="IMP_BL"><span class="header-title">IMP BL</span></th> -->
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="port"><span class="header-title">Port</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="out_date"><span class="header-title">Onboard Date</span></th>
                            <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="remark"><span class="header-title">Remark</span></th>
                            <!-- <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="EXP_BL"><span class="header-title">EXP BL</span></th> -->
                            <th class="resizable" style="background-color: #cfe2ff;">Status</th>
                            <th class="resizable" style="background-color: #cfe2ff;">Image</th>
                            <th class="resizable" style="background-color: #cfe2ff;">PDF</th>
                            <!-- <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="insert_org"><span class="header-title">U.Created</span></th> -->
                            <!-- <th class="resizable sortable-header" style="background-color: #cfe2ff;" data-sort-key="correct_org"><span class="header-title">U.Modified</span></th> -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for shipment in shipmentPage %}
                        <tr>
                            <td>
                                <input type="checkbox" value="{{ shipment.number }}" id="id_selection" name="selection" {% if shipment.number in allTickedNos %}checked{% endif %} class="form-check-input mx-auto d-block">
                            </td>
                            <td class="shipmentTableTd">
                                {% if shipment.shipment_id %}
                                <a href="{% url 'customerTracking' %}?shipment_id={{ shipment.shipment_id }}" class="shipment-id-link" data-colordiv="{{ shipment.colordiv }}">
                                    {{ shipment.shipment_id }}
                                </a>
                                {% else %}
                                    No Tracking ID
                                {% endif %}
                            </td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd clickable-cell">{{ shipment.company }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd clickable-cell">{{ shipment.vessel }}</td>
                            <!-- <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.docs }}</td> -->
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.Order_No|linebreaksbr }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.supplier }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.c_packing }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.quanty|floatformat:0 }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.unit }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.size|linebreaksbr }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.weight }}</td>
                            <td style="display: none; color: {{ shipment.colordiv }};">{{ shipment.division }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.in_date|date:"Ymd" }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.warehouse|default:""}}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.by }}</td>
                            <!-- <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.IMP_BL }}</td> -->
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.port }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.out_date|date:"Ymd"|default_if_none:'' }}</td>
                            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.remark|linebreaksbr }}</td>
                            <!-- <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.EXP_BL }}</td> -->
                            {% if shipment.flag_status %}
                                <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.flag_status }}</td>
                            {% else %}
                                <td></td>
                            {% endif %}
                            <td>
                                <div class="image-icon-container">
                                    {% for file in shipment.files.all %}
                                        {% if file.file_type == 'image' %}
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ file.file.url }}" class="image-link">
                                            <span class="image-number"></span>
                                            <img src="{{ file.file.url }}" class="img-fluid linked-image">
                                        </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                <div class="pdf-icon-container">
                                    {% for file in shipment.files.all %}
                                        {% if file.file_type == 'pdf' %}
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#pdfModal" data-pdf-url="{{ file.file.url }}" class="pdf-link">
                                            <span class="pdf-number"></span>
                                            <i class="bi bi-file-earmark-pdf pdf-icon"></i>
                                        </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </td>
                            <!-- <td class="shipmentTableTd">{{ shipment.insert_org }}</td>
                            <td class="shipmentTableTd">{{ shipment.correct_org }}</td> -->
                        </tr>
                        {% endfor %}
                        <tr style="display: none;">
                            <td style="display: none;">
                                <input type="hidden" value="" name="clicked" id="id_clicked">
                            </td>
                            <td style="display: none;">
                                <input type="hidden" value="{{ pageSticked|join:',' }}" name="pageSticked" id="id_pageSticked">
                            </td>
                            <td style="display: none;">
                                <input type="hidden" value="{{ page0Sticked|join:',' }}" name="page0Sticked" id="id_page0Sticked">
                            </td>
                            <td style="display: none;">
                                <input type="hidden" value="{{ shipmentPage.number }}" name="page" id="id_page">
                            </td>
                            <td style="display: none;">
                                <input type="hidden" value="nothing" name="statusS" id="id_statusS">
                            </td>
                            <td style="display: none;">
                                <input type="hidden" value="{% if request.method == 'POST' and allTickedNos %}{{ allTickedNos|join:',' }}{% else %}{% endif %}" name="allTickedNos" id="id_allTickedNos">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
            <button id="backToTopBtn" title="Go to top">
                <i class="bi bi-arrow-up"></i>
            </button>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" class="modal-image" alt="Full size image">
                </div>
                <div class="modal-footer">
                    <a href="#" download class="modal-image-download btn btn-primary">Download Image</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pdfModalLabel">Document Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <iframe src="" class="modal-pdf" frameborder="0"></iframe>
                </div>
                <div class="modal-footer">
                    <a href="#" target="_blank" class="modal-pdf-fallback btn btn-primary">Open in New Tab</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/scripts_shipmentList_customer.js' %}"></script>
</body>
</html>