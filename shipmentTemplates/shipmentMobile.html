{% load url_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Shipment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Existing Styles */
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        .container-fluid { background: linear-gradient(135deg, #2c3e50, #3498db); padding: 2rem 0; }
        h1 { font-size: 1.75rem; }
        .nav-tabs .nav-link { font-size: 0.9rem; padding: 0.5rem 1rem; }
        .tab-pane { padding: 1rem 0; }
        
        /* New Styles for Card Layout */
        .shipment-card {
            border: 1px solid #ddd;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #ffffff;
            transition: box-shadow 0.2s;
        }
        .shipment-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .shipment-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .shipment-card-body {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two columns for data */
            gap: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        .shipment-detail {
            display: flex;
            justify-content: space-between;
        }
        .detail-label {
            font-weight: 600;
            color: #6c757d;
            min-width: 60px;
        }
        .detail-value {
            text-align: right;
            flex-grow: 1;
        }
        
        /* Bulk Action button styles retained */
        .bulk-actions-mobile { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .bulk-actions-mobile .btn { flex: 1; min-width: 120px; }
        
        /* Other existing styles */
        .input-container { max-width: 300px; margin: 0 auto; }
        .form-control, .form-select { font-size: 1rem; }
        .toast { font-family: 'Poppins', sans-serif; }

        @media (max-width: 768px) {
            h1 { font-size: 1.6rem; }
            .container-fluid { padding: 1rem 0; }
            .input-container { max-width: 250px; }
        }
        @media (max-width: 440px) {
            h1 { font-size: 1.4rem; }
            .label-col { min-width: 60px; font-size: 0.9rem; padding-right: 1rem; }
            .input-col { font-size: 0.9rem; }
            .input-container { max-width: 100%; }
            .form-control, .form-select { font-size: 0.875rem; }
            .btn { font-size: 0.875rem; padding: 0.25rem 0.75rem; }
            
            /* Single column for details on very small screens */
            .shipment-card-body {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid px-0 m-0 shadow-sm">
    <h1 class="text-white text-center fw-bold mb-4">DATA INPUT</h1>

    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">Data successfully saved!</div>
        </div>
    </div>

    <ul class="nav nav-tabs nav-fill mx-3" id="mobileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add-shipment" type="button">
                <i class="bi bi-plus-circle"></i> Add
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="approve-tab" data-bs-toggle="tab" data-bs-target="#approve-pending" type="button">
                <i class="bi bi-shield-check"></i> Approve
                {% if pending_shipments.count > 0 %}
                    <span class="badge bg-danger ms-1">{{ pending_shipments.count }}</span>
                {% endif %}
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3 mx-3" id="mobileTabContent">

        <div class="tab-pane fade show active" id="add-shipment" role="tabpanel">
            <form method="POST" enctype="multipart/form-data" class="bg-white shadow-lg rounded-3 p-4">
                {% csrf_token %}
                <table class="table table-borderless mb-4">
                    <tbody>
                        <tr>
                            <td class="label-col fw-bold text-primary">COMPANY</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <select class="form-select" id="id_prelistCompaniesM" name="company"></select>
                                </div>
                            </td>
                        </tr>
                        {% if shipmentRegFormM.company.errors %}
                        <tr><td colspan="2" class="text-danger text-center py-2">{{ shipmentRegFormM.company.errors|striptags }}</td></tr>
                        {% endif %}

                        <tr>
                            <td class="label-col fw-bold text-primary">VESSEL</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <input class="form-control" type="text" list="datalistVesselsM" id="id_pickVesselsM" name="vessel" placeholder="Select or type">
                                    <datalist id="datalistVesselsM"></datalist>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td class="label-col fw-bold text-primary">SUPPLIER</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <input class="form-control" type="text" list="datalistSuppliersM" id="id_supplierM" name="supplier" placeholder="Select or type">
                                    <datalist id="datalistSuppliersM"></datalist>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td class="label-col fw-bold text-primary">QTY</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <input class="form-control" type="text" id="id_quantyM" name="quanty">
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td class="label-col fw-bold text-primary">C.PACKING</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <select class="form-select" id="id_c_packingM" name="c_packing">
                                        <option value="" selected>Select C. Packing</option>
                                    </select>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td class="label-col fw-bold text-primary">IN</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <input class="form-control" type="text" id="id_in_dateM" name="in_date" placeholder="YYYYMMDD">
                                </div>
                            </td>
                        </tr>
                        {% if shipmentRegFormM.in_date.errors %}
                        <tr><td colspan="2" class="text-danger text-center py-2">{{ shipmentRegFormM.in_date.errors|striptags }}</td></tr>
                        {% endif %}

                        <tr>
                            <td class="label-col fw-bold text-primary">IMAGE</td>
                            <td class="input-col">
                                <div class="input-container">
                                    <input class="form-control" type="file" id="id_image" name="image_file">
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="2" class="text-center pt-3">
                                <button class="btn btn-primary btn-sm text-white px-4 py-2" type="submit" name="addShipmentM">
                                    Save
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
        </div>

        <div class="tab-pane fade" id="approve-pending" role="tabpanel">
            {% if pending_shipments %}
            <form method="post" action="{% url 'mainPage1' %}">
                {% csrf_token %}
                
                <div class="d-flex justify-content-end mb-2 pe-1">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="select-all-mobile">
                        <label class="form-check-label" for="select-all-mobile">Select All</label>
                    </div>
                </div>

                <div class="shipment-list-container">
                    {% for p in pending_shipments %}
                    <div class="shipment-card shadow-sm">
                        <div class="shipment-card-header">
                            <h5 class="m-0 fw-bold text-primary">{{ p.company }}</h5>
                            <div class="form-check">
                                <input type="checkbox" name="selected_pending" value="{{ p.pk }}" class="form-check-input pending-checkbox">
                                <label class="form-check-label">Select</label>
                            </div>
                        </div>
                        <div class="shipment-card-body">
                            <div class="shipment-detail">
                                <span class="detail-label">Vessel:</span>
                                <span class="detail-value text-break">{{ p.vessel }}</span>
                            </div>
                            <div class="shipment-detail">
                                <span class="detail-label">Qty:</span>
                                <span class="detail-value">{{ p.quanty }}</span>
                            </div>
                            <div class="shipment-detail">
                                <span class="detail-label">Weight:</span>
                                <span class="detail-value">{{ p.weight }}</span>
                            </div>
                            <div class="shipment-detail">
                                <span class="detail-label">Size:</span>
                                <span class="detail-value">{{ p.size }}</span>
                            </div>
                            <div class="shipment-detail">
                                <span class="detail-label">Supplier:</span>
                                <span class="detail-value text-break">{{ p.supplier }}</span>
                            </div>
                            <div class="shipment-detail">
                                <span class="detail-label">By:</span>
                                <span class="detail-value">{{ p.submitted_by.userID }}</span>
                            </div>
                            <div class="shipment-detail">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value">{{ p.submission_date|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="bulk-actions-mobile">
                    <button type="submit" name="bulk_approve" class="btn btn-success btn-lg d-flex align-items-center justify-content-center gap-2" id="btn-approve-mobile" disabled>
                        <i class="bi bi-check-circle-fill"></i> Approve
                    </button>
                    <button type="submit" name="bulk_reject" class="btn btn-danger btn-lg d-flex align-items-center justify-content-center gap-2" id="btn-reject-mobile" disabled>
                        <i class="bi bi-x-circle-fill"></i> Reject
                    </button>
                </div>
            </form>
            {% else %}
            <div class="alert alert-info text-center p-3">
                <i class="bi bi-check-all"></i> No pending shipments.
            </div>
            {% endif %}
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === Toast on successful Add ===
        {% if not shipmentRegFormM.errors and request.method == "POST" and "addShipmentM" in request.POST %}
            const fields = ['id_prelistCompaniesM', 'id_pickVesselsM', 'id_supplierM', 'id_quantyM', 'id_c_packingM', 'id_in_dateM'];
            const hasImage = document.getElementById('id_image').files.length > 0;
            const allFilled = fields.every(id => {
                const element = document.getElementById(id);
                // Check if it's a select element and value is not empty, or an input and value is not empty
                return element && element.value.trim() !== '';
            });
            // The image check is now done in the `allFilled` variable check for consistency.
            if (allFilled) {
                const toast = new bootstrap.Toast(document.getElementById('successToast'));
                toast.show();
            }
        {% endif %}

        // === Bulk Actions in Approve Tab ===
        const checkboxes = document.querySelectorAll('.pending-checkbox');
        const selectAll = document.getElementById('select-all-mobile');
        const btnApprove = document.getElementById('btn-approve-mobile');
        const btnReject = document.getElementById('btn-reject-mobile');

        function updateButtons() {
            const checked = document.querySelectorAll('.pending-checkbox:checked').length > 0;
            if (btnApprove) btnApprove.disabled = !checked;
            if (btnReject) btnReject.disabled = !checked;
        }

        checkboxes.forEach(cb => cb.addEventListener('change', () => {
            updateButtons();
            const allChecked = Array.from(checkboxes).length > 0 && Array.from(checkboxes).every(c => c.checked);
            const someChecked = Array.from(checkboxes).some(c => c.checked);
            
            if (selectAll) {
                // Set 'Select All' to indeterminate if some but not all are checked
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            }
        }));

        if (selectAll) {
            selectAll.addEventListener('change', (e) => {
                checkboxes.forEach(cb => cb.checked = e.target.checked);
                selectAll.indeterminate = false; // Reset indeterminate state
                updateButtons();
            });
        }

        // Initial state update is crucial, especially if there are existing checkboxes
        updateButtons();
        // Manually check initial 'select all' state after updateButtons
        const initialAllChecked = Array.from(checkboxes).length > 0 && Array.from(checkboxes).every(c => c.checked);
        const initialSomeChecked = Array.from(checkboxes).some(c => c.checked);
        if (selectAll) {
            selectAll.checked = initialAllChecked;
            selectAll.indeterminate = initialSomeChecked && !initialAllChecked;
        }
    });
</script>
</body>
</html>