{% load url_tags %}
{% load static %}
<script src="{% static 'js/shipmentDis1Functions.js' %}" defer></script>

<div class="container-fluid py-4 shipment-box">
  <h1 class="display-5 fw-bold text-primary mb-5 shipment-form-header">
    <i class="bi bi-list-ul me-2"></i>Shipment List
  </h1>

  <!-- Selected Rows Display -->
  <div class="selected-rows d-inline-flex align-items-center mb-4 bg-white shadow-sm rounded p-2">
    <span class="me-2 text-primary">Selected rows:</span>
    <span id="totalTicked" class="badge bg-primary rounded-pill fw-bold" aria-label="0 rows selected">0</span>
  </div>

  <form method="POST" class="shipment-table-form shadow-lg rounded-3 p-4 bg-white" id="shipmentTableForm">
    {% csrf_token %}
    <div class="table-responsive">
      <table id="shipmentTable" class="table table-bordered table-hover mb-0">
        <thead>
          <tr class="table-primary">
            <th scope="col" class="checkbox-col"><input type="checkbox" class="form-check-input" id="id_selectall" aria-label="Select all shipments"></th>
            <th scope="col" class="shipment-table-th">SHIPMENT ID</th>
            <th scope="col" class="shipment-table-th">COMPANY</th>
            <th scope="col" class="shipment-table-th">VESSEL</th>
            <th scope="col" class="shipment-table-th">DOC</th>
            <th scope="col" class="shipment-table-th">Ask.No</th>
            <th scope="col" class="shipment-table-th">Po.No</th>
            <th scope="col" class="shipment-table-th">SUPPLIER</th>
            <th scope="col" class="shipment-table-th">C.PACKING</th>
            <th scope="col" class="shipment-table-th">QTY</th>
            <th scope="col" class="shipment-table-th">UNIT</th>
            <th scope="col" class="shipment-table-th">SIZE</th>
            <th scope="col" class="shipment-table-th">WEIGHT</th>
            <th scope="col" class="shipment-table-th" style="display: none;"></th>
            <th scope="col" class="shipment-table-th">IN</th>
            <th scope="col" class="shipment-table-th">W/H</th>
            <th scope="col" class="shipment-table-th">BY</th>
            <th scope="col" class="shipment-table-th">BLNO</th>
            <th scope="col" class="shipment-table-th">PORT</th>
            <th scope="col" class="shipment-table-th">ONBOARD DATE</th>
            <th scope="col" class="shipment-table-th">REMARK</th>
            <th scope="col" class="shipment-table-th">MEMO</th>
            <th scope="col" class="shipment-table-th">JOB NO</th>
            <th scope="col" class="shipment-table-th">STATUS</th>
            <th scope="col" class="shipment-table-th">IMAGE</th>
            <th scope="col" class="shipment-table-th">PDF</th>
            <th scope="col" class="shipment-table-th">USER CREATED</th>
            <th scope="col" class="shipment-table-th">USER MODIFIED</th>
          </tr>
          <tr>
            <th id="totalRow" colspan="28" class="text-end fw-bold py-2">TOTAL: {{ totalResults }}</th>
          </tr>
        </thead>
        <tbody>
          {% for shipment in shipmentPage %}
          <tr>
            <td class="checkbox-col">
              <input type="checkbox" value="{{ shipment.number }}" name="selection" {% if shipment.number in allTickedNos %}checked{% endif %} class="form-check-input mx-auto d-block" aria-label="Select shipment {{ shipment.number }}">
            </td>
            <td class="shipment-table-td">
              <a href="{% url 'shipmentTrackingView' shipment.shipment_id %}" class="shipment-id-link" data-colordiv="{{ shipment.colordiv }}">{{ shipment.shipment_id }}</a>
            </td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.company }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.vessel }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.docs }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.ASKno|default_if_none:''|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.POno|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.supplier }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.c_packing }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.quanty|floatformat:0 }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.unit }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.size|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.weight }}</td>
            <td style="display: none; color: {{ shipment.colordiv }};">{{ shipment.division }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.in_date|date:"Ymd" }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.warehouse }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.by }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.BLno }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.port }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.out_date|date:"Ymd"|default_if_none:'' }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.remark|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.memo }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipment-table-td">{{ shipment.job_number }}</td>
            <td class="shipment-table-td">
              {% if shipment.flag_status == "STAY" %}
                <img src="{% static 'images/stay1.png' %}" class="img-fluid status-image" alt="Stay status" loading="lazy">
              {% elif shipment.flag_status == "START" %}
                <img src="{% static 'images/start1.png' %}" class="img-fluid status-image" alt="Start status" loading="lazy">
              {% elif shipment.flag_status == "COMPLETED" %}
                <img src="{% static 'images/completed2.png' %}" class="img-fluid status-image" alt="Completed status" loading="lazy">
              {% else %}
                <span aria-hidden="true"></span>
              {% endif %}
            </td>
            <td class="shipment-table-td">
              {% if shipment.image %}
                <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ shipment.image.url }}">
                  <img src="{{ shipment.image.url }}" class="img-fluid linked-image" alt="Shipment image" loading="lazy">
                </a>
              {% endif %}
            </td>
            <td class="shipment-table-td">
              {% if shipment.pdf_file %}
                <a href="#" data-bs-toggle="modal" data-bs-target="#pdfModal" data-pdf-url="{{ shipment.pdf_file.url }}">
                  <i class="bi bi-file-earmark-pdf pdf-icon" aria-label="View PDF"></i>
                </a>
              {% endif %}
            </td>
            <td class="shipment-table-td">{{ shipment.insert_org }}</td>
            <td class="shipment-table-td">{{ shipment.correct_org }}</td>
          </tr>
          {% endfor %}
          <tr>
            <td colspan="28" class="text-end">
              <button class="btn omega-mod-button" type="submit" name="exportExcelShipment" id="exportExcelShipment">Export Selections To Excel</button>
            </td>
          </tr>
        </tbody>
      </table>
      <input type="hidden" value="" name="clicked" id="id_clicked">
      <input type="hidden" value="{{ pageSticked|join:',' }}" name="pageSticked" id="id_pageSticked">
      <input type="hidden" value="{{ page0Sticked|join:',' }}" name="page0Sticked" id="id_page0Sticked">
      <input type="hidden" value="{{ shipmentPage.number }}" name="page" id="id_page">
      <input type="hidden" value="nothing" name="statusS" id="id_statusS">
      <input type="hidden" value="{% if request.method == 'POST' and allTickedNos %}{{ allTickedNos|join:',' }}{% else %}{% endif %}" name="allTickedNos" id="id_allTickedNos">
      <input type="hidden" id="id_page1Sticked" name="page1Sticked">
      <input type="hidden" name="pageSticked" value="{% for shipment in shipmentPage %}{{ shipment.number }}{% if not forloop.last %},{% endif %}{% endfor %}">
    </div>
  </form>

  <!-- Image Preview Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <img src="" class="img-fluid modal-image" alt="Image Preview">
        </div>
        <div class="modal-footer">
          <a href="" class="btn btn-primary modal-image-download" download>Download Image</a>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF Preview Modal -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel">PDF Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="" class="modal-pdf" style="width: 100%; height: 600px;"></iframe>
          <p class="text-center mt-2">
            <a href="" class="modal-pdf-fallback text-primary">Download PDF</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <nav class="d-flex justify-content-end mt-4 me-4" aria-label="Page navigation">
    <div class="d-flex align-items-center">
      <label for="pageSelect" class="me-2">Page:</label>
      <select id="pageSelect" name="pageSelect" class="form-select">
        {% for num in shipmentPage.paginator.page_range %}
          <option value="{{ num }}" {% if num == shipmentPage.number %}selected{% endif %}>
            {{ num }} of {{ shipmentPage.paginator.num_pages }}
          </option>
        {% endfor %}
      </select>
    </div>
  </nav>
</div>

<style>
  :root {
    --primary-color: #007bff;
    --border-color: #dee2e6;
    --hover-bg: #d1ecf1;
    --odd-row-bg: #f8f9fa;
    --even-row-bg: #e9ecef;
  }

  .shipment-box {
    font-family: 'Poppins', sans-serif;
  }

  .selected-rows {
    border: 0.5px solid var(--border-color);
    max-width: 200px;
    font-size: 0.9rem;
  }

  .shipment-table-form {
    max-width: 100%;
    margin-bottom: 1rem;
  }

  .table-responsive {
    overflow-x: auto;
    position: relative;
  }

  #shipmentTable {
    border-radius: 0.5rem;
    overflow: hidden;
    min-width: 100%;
  }

  .shipment-table-th, .shipment-table-td {
    border-right: 1px solid var(--border-color);
    position: relative;
    font-size: 0.65rem;
    vertical-align: middle;
    user-select: text;
  }

  .checkbox-col {
    width: 2%;
    min-width: 20px;
    text-align: center;
  }

  #shipmentTable tbody tr:nth-child(odd) .shipment-table-td {
    background-color: var(--odd-row-bg);
  }

  #shipmentTable tbody tr:nth-child(even) .shipment-table-td {
    background-color: var(--even-row-bg);
  }

  #shipmentTable.table-hover tbody tr:hover .shipment-table-td {
    background-color: var(--hover-bg);
  }

  .shipment-table-td:nth-child(11) {
    white-space: pre-wrap;
  }

  .form-check-input {
    width: 0.9rem;
    height: 0.9rem;
  }

  .status-image {
    max-width: 2rem;
    max-height: 2rem;
  }

  .linked-image {
    max-width: 4rem;
    max-height: 3rem;
    cursor: pointer;
  }

  .pdf-icon {
    font-size: 2rem;
    color: #dc3545;
    cursor: pointer;
  }

  .pdf-icon:hover {
    color: #bd2130;
  }

  .shipment-id-link {
    text-decoration: underline;
    transition: transform 0.2s ease, color 0.2s ease, background-color 0.2s ease;
    padding: 2px 4px;
    border-radius: 3px;
  }

  .shipment-id-link:hover {
    transform: scale(1.05);
    color: #0056b3;
    background-color: rgba(0, 123, 255, 0.1);
  }

  .resize-bar {
    position: absolute;
    top: 0;
    width: 10px;
    height: 100%;
    cursor: col-resize;
    z-index: 10;
    background: transparent;
  }

  .resize-bar:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  .form-select {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }

  .form-select:focus {
    border-color: #0056b3;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .modal-image {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: 0 auto;
  }

  .modal-pdf {
    border: none;
  }

  .modal-pdf-fallback, .modal-image-download {
    font-size: 0.9rem;
  }

  .omega-mod-button {
    width: 5.5cm;
    margin-left: 1cm;
  }

  #totalRow {
    background-color: var(--even-row-bg);
  }
</style>