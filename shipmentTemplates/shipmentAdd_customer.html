{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Shipment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bs-primary: #0077b6;
        }
        .text-primary { color: var(--bs-primary) !important; }
        .btn-primary { 
            --bs-btn-bg: var(--bs-primary);
            --bs-btn-border-color: var(--bs-primary);
            --bs-btn-hover-bg: #005a8f;
            --bs-btn-hover-border-color: #005a8f;
        }
        .center-card {
            max-width: 800px;
            margin: 0 auto;
        }
        .form-floating > .form-control,
        .form-floating > .form-select,
        .form-floating > .form-control:focus,
        .form-floating > .form-select:focus,
        .form-floating > .form-control:not(:placeholder-shown),
        .form-floating > .form-select:not(:placeholder-shown) {
            padding-top: 1.625rem !important; 
            padding-bottom: 0.625rem !important;
            height: calc(3.5rem + 2px);
        }
        .form-floating > label {
            padding: 1rem 0.75rem; 
            font-size: 1rem; 
            height: 100%; 
            color: #6c757d;
        }
        .form-floating > .form-control:focus ~ label,
        .form-floating > .form-control:not(:placeholder-shown) ~ label,
        .form-floating > .form-select ~ label {
            transform: scale(0.85) translateY(-0.75rem) translateX(0.15rem); 
            font-weight: 600;
            color: var(--bs-primary); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5"> 
        <div class="w-100 center-card">
            <h1 class="display-5 fw-bold text-primary mb-4 text-center">
                <i class="bi bi-box-seam me-2"></i>New Shipment Request
            </h1>
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-4">
                    <h2 class="card-title fs-4 fw-bold mb-3 border-bottom pb-2">
                        Enter Shipment Details
                    </h2>
                    <form method="POST" action="" id="shipmentRegForm">
                        {% csrf_token %}
                        <div class="row g-3"> 
                            <!-- COMPANY FIELD -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input 
                                        class="form-control" 
                                        type="text" 
                                        list="datalistCompaniesReg" 
                                        id="id_prelistCompanies" 
                                        name="company" 
                                        placeholder="Company"
                                    >
                                    <label for="id_prelistCompanies">Company</label>
                                    <datalist id="datalistCompaniesReg"></datalist>
                                </div>
                            </div>
                            <!-- QUANTITY FIELD -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" type="number" step="1" id="id_quanty" name="quanty" placeholder="Quantity">
                                    <label for="id_quanty">Quantity</label>
                                </div>
                            </div>
                            <!-- VESSEL FIELD -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input 
                                        class="form-control" 
                                        type="text" 
                                        list="datalistVessels" 
                                        id="id_pickVessels" 
                                        name="vessel" 
                                        placeholder="Vessel"
                                    >
                                    <label for="id_pickVessels">Vessel</label>
                                    <datalist id="datalistVessels"></datalist>
                                </div>
                            </div>
                            <!-- WEIGHT FIELD -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" type="number" step="0.01" id="id_weight" name="weight" placeholder="Weight">
                                    <label for="id_weight">Weight</label>
                                </div>
                            </div>
                            <!-- SUPPLIER FIELD -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {% if request.user.isSpl %}
                                        <input class="form-control" type="text" id="id_supplier" name="supplier" 
                                               placeholder="Supplier" value="{{ supplier_name }}" readonly>
                                    {% else %}
                                        <input class="form-control" type="text" list="datalistSuppliers" 
                                               id="id_supplier" name="supplier" placeholder="Select or type">
                                        <datalist id="datalistSuppliers"></datalist>
                                    {% endif %}
                                    <label for="id_supplier">Supplier</label>
                                </div>
                            </div>
                            <!-- SIZE FIELD -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" type="text" id="id_size" name="size" placeholder="Size">
                                    <label for="id_size">Size</label>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" name="add_pending_shipment" class="btn btn-primary btn-lg rounded-pill shadow-sm">
                                <i class="bi bi-send-check me-2"></i> Submit for Approval
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
    // Sample autofillOnVessels function
    function autofillOnVessels1(idVesselCell, idCompanyCell,
        dataTag='#jsonDatalistVesselMap') {
        var vesselSmartPick = document.getElementById(idVesselCell);
        var companyAutofill = document.getElementById(idCompanyCell);
        var vesselMap = loadJsonData(dataTag);
        var vesselOwnedList = vesselMap.map((item)=>item.vessel);
        var vesselOwnerList = vesselMap.map((item)=>item.vesselOwner);

        vesselSmartPick.onchange = function() {
            let vesselPicked = vesselSmartPick.value;
            let idxPicked = vesselOwnedList.indexOf(vesselPicked);
            companyAutofill.value = vesselOwnerList[idxPicked];
        }
    }

    // Helper function (assumed, adjust if different)
    function loadJsonData(selector) {
        const element = document.querySelector(selector);
        if (!element) {
            console.error(`Element ${selector} not found`);
            return null;
        }
        try {
            return JSON.parse(element.dataset.json || '[]');
        } catch (e) {
            console.error(`Failed to parse JSON for ${selector}: ${e}`);
            return null;
        }
    }

    // Helper function for datalist (assumed, adjust if different)
    function setupDatalistCell(listId, dataId) {
        const datalist = document.getElementById(listId);
        const data = loadJsonData(dataId);
        if (datalist && data) {
            datalist.innerHTML = data.map(item => `<option value="${item}"></option>`).join('');
        } else {
            console.warn(`Failed to setup datalist ${listId}`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // console.log('DOMContentLoaded event fired for add by supplier');

        // Element selectors
        const shipmentRegForm = document.getElementById('shipmentRegForm');

        // JSON data from hidden divs (mainPage2.html)
        const companiesData = loadJsonData('#jsonDataPrelistCompanies');
        const vesselsData = loadJsonData('#jsonDatalistVessels');


        // Initialize form fields
        if (shipmentRegForm) {

            // Setup datalist fields
            const datalistFields = [
                { listId: 'datalistCompaniesReg', dataId: '#jsonDataPrelistCompanies' },
                { listId: 'datalistVessels', dataId: '#jsonDatalistVessels' }
            ];

            datalistFields.forEach(field => {
                const data = loadJsonData(field.dataId);
                if (data) {
                    setupDatalistCell(field.listId, field.dataId);
                    // console.log(`Datalist ${field.listId} setup complete`);
                } else {
                    console.warn(`Data for ${field.listId} is missing or invalid`);
                }
            });

            // Setup vessel autofill based on company
            if (companiesData && vesselsData) {
                autofillOnVessels1('id_pickVessels', 'id_prelistCompanies');
            } else {
                console.warn('Missing data for company or vessel autofill');
                console.warn('Reason: companiesData is', companiesData, ', vesselsData is', vesselsData);
            }
        } else {
            console.error('Shipment registration form not found');
        }
    });
</script>
</body>
</html>