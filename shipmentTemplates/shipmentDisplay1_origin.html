{% load url_tags %}
{% load static %}
<script src="{% static 'js/shipmentDis1Functions.js' %}" defer></script>

<div class="container-fluid py-4 shipmentBox">
  <h1 class="display-5 fw-bold text-primary mb-5 shipmentFormHeader">
    <i class="bi bi-list-ul me-2"></i>Shipment List
  </h1>

  <!-- Selected Rows Display -->
  <div class="d-inline-flex align-items-center mb-4 bg-white shadow-sm rounded p-2" style="border: 0.5px solid #dee2e6; max-width: 200px;">
    <span class="me-2 text-primary" style="font-family: 'Poppins', sans-serif; font-size: 0.9rem;">Selected rows:</span>
    <span id="totalTicked" class="badge bg-primary rounded-pill fw-bold">0</span>
  </div>

  <form method="POST" class="shadow-lg rounded-3 p-4 bg-white" style="max-width: 100%; margin: 0 auto; margin-bottom: 1rem;" id="shipmentTableForm">
    {% csrf_token %}
    <div class="table-responsive" style="position: relative;">
      <table id="shipmentTable" class="table table-bordered table-hover mb-0" style="border-radius: 0.5rem; overflow: hidden; position: relative; min-width: 100%;">
        <thead>
          <tr class="table-primary">
            <th scope="col" style="width: 2%; min-width: 20px;">
              <input type="checkbox" class="form-check-input" id="id_selectall">
            </th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">SHIPMENT ID</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">COMPANY</th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">VESSEL</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">DOC</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 50px; font-size: 0.65rem;">Ask.No</th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">Po.No</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">SUPPLIER</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">C.PACKING</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 25px; font-size: 0.65rem;">QTY</th>
            <th scope="col" class="shipmentTableTh" style="width: 3%; min-width: 25px; font-size: 0.65rem;">UNIT</th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">SIZE</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">WEIGHT</th>
            <th scope="col" class="shipmentTableTh" style="width: 0; min-width: 0; font-size: 0.65rem; display: none;"></th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">IN</th>
            <th scope="col" class="shipmentTableTh" style="width: 3%; min-width: 25px; font-size: 0.65rem;">W/H</th>
            <th scope="col" class="shipmentTableTh" style="width: 3%; min-width: 25px; font-size: 0.65rem;">BY</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">BLNO</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">PORT</th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 50px; font-size: 0.65rem;">ONBOARD DATE</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">REMARK</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 60px; font-size: 0.65rem;">MEMO</th>
            <th scope="col" class="shipmentTableTh" style="width: 7%; min-width: 60px; font-size: 0.65rem;">JOB NO</th>
            <th scope="col" class="shipmentTableTh" style="width: 4%; min-width: 30px; font-size: 0.65rem;">STATUS</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">IMAGE</th>
            <th scope="col" class="shipmentTableTh" style="width: 5%; min-width: 40px; font-size: 0.65rem;">PDF</th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 40px; font-size: 0.65rem;">USER CREATED</th>
            <th scope="col" class="shipmentTableTh" style="width: 6%; min-width: 40px; font-size: 0.65rem;">USER MODIFIED</th>
          </tr>
          <tr>
            <th id="totalRow" colspan="28" class="text-end fw-bold py-2" style="width: 100%; background-color: #e9ecef;">
              TOTAL: {{ totalResults }}
            </th>
          </tr>
        </thead>
        <tbody>
          {% for shipment in shipmentPage %}
          <tr>
            <td>
              <input type="checkbox" value="{{ shipment.number }}" id="id_selection" name="selection" {% if shipment.number in allTickedNos %}checked{% endif %} class="form-check-input mx-auto d-block">
            </td>
            <td class="shipmentTableTd">
              <a href="{% url 'shipmentTrackingView' shipment.shipment_id %}" class="shipment-id-link" data-colordiv="{{ shipment.colordiv }}">
                {{ shipment.shipment_id }}
              </a>
            </td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.company }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.vessel }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.docs }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.ASKno|default_if_none:''|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.POno|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.supplier }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.c_packing }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.quanty|floatformat:0 }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.unit }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.size|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.weight }}</td>
            <td style="display: none; color: {{ shipment.colordiv }};">{{ shipment.division }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.in_date|date:"Ymd" }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.warehouse }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.by }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.BLno }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.port }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.out_date|date:"Ymd"|default_if_none:'' }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.remark|linebreaksbr }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.memo }}</td>
            <td style="color: {{ shipment.colordiv }};" class="shipmentTableTd">{{ shipment.job_number }}</td>
            {% if shipment.flag_status == "STAY" %}
            <td><img src="{% static 'images/stay1.png' %}" class="img-fluid status-image"></td>
            {% elif shipment.flag_status == "START" %}
            <td><img src="{% static 'images/start1.png' %}" class="img-fluid status-image"></td>
            {% elif shipment.flag_status == "COMPLETED" %}
            <td><img src="{% static 'images/completed2.png' %}" class="img-fluid status-image"></td>
            {% else %}
            <td></td>
            {% endif %}
            <td>
              {% if shipment.image %}
              <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ shipment.image.url }}">
                <img src="{{ shipment.image.url }}" class="img-fluid linked-image">
              </a>
              {% endif %}
            </td>
            <td>
              {% if shipment.pdf_file %}
              <a href="#" data-bs-toggle="modal" data-bs-target="#pdfModal" data-pdf-url="{{ shipment.pdf_file.url }}">
                <i class="bi bi-file-earmark-pdf pdf-icon"></i>
              </a>
              {% endif %}
            </td>
            <td class="shipmentTableTd">{{ shipment.insert_org }}</td>
            <td class="shipmentTableTd">{{ shipment.correct_org }}</td>
          </tr>
          {% endfor %}
          <tr>
            <td colspan="28">
              <div class="d-flex flex-row justify-content-end">
                <button class="btn omegaModButton" type="submit" style="width: 5.5cm; margin-left: 1cm;" name="exportExcelShipment" id="exportExcelShipment">Export Selections To Excel</button>
              </div>
            </td>
          </tr>
          <tr style="display: none;">
            <td style="display: none;">
              <input type="hidden" value="" name="clicked" id="id_clicked">
            </td>
            <td style="display: none;">
              <input type="hidden" value="{{ pageSticked|join:',' }}" name="pageSticked" id="id_pageSticked">
            </td>
            <td style="display: none;">
              <input type="hidden" value="{{ page0Sticked|join:',' }}" name="page0Sticked" id="id_page0Sticked">
            </td>
            <td style="display: none;">
              <input type="hidden" value="{{ shipmentPage.number }}" name="page" id="id_page">
            </td>
            <td style="display: none;">
              <input type="hidden" value="nothing" name="statusS" id="id_statusS">
            </td>
            <td style="display: none;">
              <input type="hidden" value="{% if request.method == 'POST' and allTickedNos %}{{ allTickedNos|join:',' }}{% else %}{% endif %}" name="allTickedNos" id="id_allTickedNos">
            </td>
          </tr>
        </tbody>
      </table>
      <input type="hidden" id="id_page1Sticked" name="page1Sticked">
      <input type="hidden" name="pageSticked" value="{% for shipment in shipmentPage %}{{ shipment.number }}{% if not forloop.last %},{% endif %}{% endfor %}">
    </div>
  </form>

  <!-- Image Preview Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <img src="" class="img-fluid modal-image" alt="Image Preview">
        </div>
        <div class="modal-footer">
          <a href="" class="btn btn-primary modal-image-download" download>Download Image</a>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF Preview Modal -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel">PDF Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="" class="modal-pdf" style="width: 100%; height: 600px;"></iframe>
          <p class="text-center mt-2">
            <a href="" class="modal-pdf-fallback text-primary">Download PDF</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end mt-4 me-4">
    <nav aria-label="Page navigation">
      <div class="d-flex align-items-center">
        <label for="pageSelect" class="me-2" style="font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
          Page:
        </label>
        <select id="pageSelect" name="pageSelect" class="form-select" style="width: auto; font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
          {% for num in shipmentPage.paginator.page_range %}
            <option value="{{ num }}" {% if num == shipmentPage.number %}selected{% endif %}>
              {{ num }} of {{ shipmentPage.paginator.num_pages }}
            </option>
          {% endfor %}
        </select>
      </div>
    </nav>
  </div>
</div>

<style>
  #shipmentTable tbody tr:nth-child(odd) td {
    background-color: #f8f9fa !important;
  }
  #shipmentTable tbody tr:nth-child(even) td {
    background-color: #e9ecef !important;
  }
  #shipmentTable.table-hover tbody tr:hover td {
    background-color: #d1ecf1 !important;
  }
  #shipmentTable td:nth-child(11) {
    white-space: pre-wrap;
  }
  .form-check-input {
    margin: 0;
    width: 0.9rem;
    height: 0.9rem;
  }
  #shipmentTable td:nth-child(24) img.status-image {
    max-width: 2rem;
    max-height: 2rem;
  }
  #shipmentTable td:nth-child(25) img.linked-image {
    max-width: 4rem;
    max-height: 3rem;
    cursor: pointer;
  }
  #shipmentTable td:nth-child(26) i.pdf-icon {
    font-size: 2rem;
    color: #dc3545;
    cursor: pointer;
  }
  #shipmentTable td:nth-child(26) i.pdf-icon:hover {
    color: #bd2130;
  }
  .resize-bar {
    position: absolute;
    top: 0;
    width: 10px;
    height: 100%;
    cursor: col-resize;
    z-index: 10;
    background: transparent;
  }
  .resize-bar:hover {
    background: rgba(0, 0, 0, 0.2);
  }
  #shipmentTable th, #shipmentTable td {
    border-right: 1px solid #dee2e6;
    position: relative;
  }
  .form-select {
    border-color: #007bff;
    color: #007bff;
  }
  .form-select:focus {
    border-color: #0056b3;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  .table-responsive {
    overflow-x: auto;
    overflow-y: hidden;
  }
  .modal-image {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: 0 auto;
  }
  .modal-pdf {
    border: none;
  }
  .modal-pdf-fallback {
    font-size: 0.9rem;
    text-decoration: underline;
  }
  .modal-image-download {
    font-size: 0.9rem;
  }
  #shipmentTable .shipmentTableTd .shipment-id-link {
    display: inline-block; /* Enable transform */
    text-decoration: underline;
    transition: transform 0.2s ease, color 0.2s ease, background-color 0.2s ease;
    padding: 2px 4px; /* Small padding for hover background */
    border-radius: 3px; /* Smooth corners */
  }
  #shipmentTable .shipmentTableTd .shipment-id-link:hover {
    transform: scale(1.05);
    color: #0056b3 !important; /* Bootstrap primary, override colordiv */
    background-color: rgba(0, 123, 255, 0.1); /* Light blue background */
    cursor: pointer;
  }
  .shipmentTableTd {
    user-select: text !important; /* Allow text selection */
    -webkit-user-select: text !important; /* For Safari */
    -moz-user-select: text !important; /* For Firefox */
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('shipmentTable');
    const container = table.parentElement;
    const form = container.parentElement;
    const headers = table.querySelectorAll('th:not([style*="display: none"])');
    const totalRow = document.getElementById('totalRow');

    // Initialize ticked count
    function updateTickedCount() {
      fetch('/main1/pageSelect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ action: 'get' }),
      }).then(response => response.json()).then(data => {
        console.log(`updateTickedCount: ${data.tickedNos.length} tickedNos`, data.tickedNos);
        const totalTicked = document.getElementById('totalTicked');
        if (totalTicked) {
          totalTicked.textContent = data.tickedNos.length;
          totalTicked.setAttribute('data-label', `${data.tickedNos.length} ${data.tickedNos.length === 1 ? 'row' : 'rows'} selected`);
          const checkboxes = document.querySelectorAll('input[name="selection"]');
          checkboxes.forEach(cb => {
            cb.checked = data.tickedNos.includes(parseInt(cb.value));
          });
          const selectAll = document.getElementById('id_selectall');
          if (selectAll) {
            selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
          }
          const allTickedNosInput = document.getElementById('id_allTickedNos');
          if (allTickedNosInput && data.tickedNos.length === 0) {
            allTickedNosInput.value = '';
          }
        }
      }).catch(error => {
        console.error('updateTickedCount error:', error);
      });
    }
    updateTickedCount();

    // Reset checkboxes after form submission
    const form1 = document.getElementById('shipmentTableForm');
    if (form1) {
      form1.addEventListener('submit', () => {
        setTimeout(() => {
          const checkboxes = document.querySelectorAll('input[name="selection"]');
          const selectAll = document.getElementById('id_selectall');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          if (selectAll) selectAll.checked = false;
          const allTickedNosInput = document.getElementById('id_allTickedNos');
          if (allTickedNosInput) {
            allTickedNosInput.value = '';
          }
          updateTickedCount();
        }, 1000);
      });
    }

    // Export button
    const exportButton = document.getElementById('exportExcelShipment');
    if (exportButton) {
      exportButton.addEventListener('click', function(event) {
        fetch('/main1/pageSelect', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ action: 'get' }),
        }).then(response => response.json()).then(data => {
          if (data.tickedNos.length === 0) {
            alert('Please select at least one shipment to export.');
            event.preventDefault();
            return;
          }

          const allTickedNosInput = document.getElementById('id_allTickedNos');
          if (allTickedNosInput) {
            allTickedNosInput.value = data.tickedNos.join(',');
          }

          const checkboxes = document.querySelectorAll('input[name="selection"]');
          const selectAll = document.getElementById('id_selectall');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          if (selectAll) selectAll.checked = false;

          const form = document.getElementById('shipmentTableForm');
          if (form) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'exportExcelShipment';
            input.value = 'true';
            form.appendChild(input);
            form.submit();
            setTimeout(updateTickedCount, 1000);
          }
        }).catch(error => {
          console.error('Fetch error:', error);
          event.preventDefault();
        });
      });
    }

    // Debug buttons
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      console.log('Button found:', button, 'Text:', button.textContent, 'ID:', button.id);
    });

    // Modal content handling
    const imageModal = document.getElementById('imageModal');
    const pdfModal = document.getElementById('pdfModal');
    const modalImage = imageModal.querySelector('.modal-image');
    const modalPdf = pdfModal.querySelector('.modal-pdf');
    const modalImageDownload = imageModal.querySelector('.modal-image-download');
    const modalPdfFallback = pdfModal.querySelector('.modal-pdf-fallback');

    imageModal.addEventListener('show.bs.modal', function(event) {
      const link = event.relatedTarget;
      const imageUrl = link.getAttribute('data-image-url');
      console.log('Image URL:', imageUrl);
      modalImage.src = imageUrl;
      modalImageDownload.href = imageUrl;
    });

    pdfModal.addEventListener('show.bs.modal', function(event) {
      const link = event.relatedTarget;
      const pdfUrl = link.getAttribute('data-pdf-url');
      console.log('PDF URL:', pdfUrl);
      modalPdf.src = pdfUrl;
      modalPdfFallback.href = pdfUrl;
    });

    // Clear modal content when hidden to prevent memory leaks
    imageModal.addEventListener('hidden.bs.modal', function() {
      modalImage.src = '';
      modalImageDownload.href = '';
    });

    pdfModal.addEventListener('hidden.bs.modal', function() {
      modalPdf.src = '';
      modalPdfFallback.href = '';
    });

    // Table resizing and scrolling
    const adjustContainerHeight = () => {
      const tableHeight = table.offsetHeight;
      container.style.minHeight = `${tableHeight}px`;
      const formPadding = parseFloat(getComputedStyle(form).paddingTop) + parseFloat(getComputedStyle(form).paddingBottom);
      form.style.minHeight = `${tableHeight + formPadding}px`;
    };
    adjustContainerHeight();

    const initialWidths = [];
    headers.forEach(th => {
      const width = th.offsetWidth;
      th.style.width = `${width}px`;
      initialWidths.push(width);
    });

    totalRow.style.width = `${table.offsetWidth}px`;

    const bars = [];
    headers.forEach((th, index) => {
      const bar = document.createElement('div');
      bar.className = 'resize-bar';
      let leftPos = 0;
      for (let i = 0; i < index; i++) {
        leftPos += headers[i].offsetWidth;
      }
      bar.style.left = `${leftPos + th.offsetWidth - 5}px`;
      container.appendChild(bar);
      bars.push(bar);

      let startX, startWidth, initialTableWidth;
      const startDraggingResize = (e) => {
        startX = e.pageX;
        startWidth = th.offsetWidth;
        initialTableWidth = table.offsetWidth;
        document.addEventListener('mousemove', doDraggingResize);
        document.addEventListener('mouseup', stopDraggingResize);
      };

      const doDraggingResize = (e) => {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth >= parseInt(th.style.minWidth)) {
          th.style.width = `${newWidth}px`;
          const newTableWidth = initialTableWidth + (newWidth - startWidth);
          table.style.width = `${newTableWidth}px`;
          totalRow.style.width = `${newTableWidth}px`;
          bar.style.left = `${leftPos + newWidth - 5}px`;
          updateBarPositions();
          adjustContainerHeight();
        }
      };

      const stopDraggingResize = () => {
        document.removeEventListener('mousemove', doDraggingResize);
        document.removeEventListener('mouseup', stopDraggingResize);
      };

      bar.addEventListener('mousedown', startDraggingResize);
    });

    const updateBarPositions = () => {
      let leftPos = 0;
      headers.forEach((th, index) => {
        leftPos += th.offsetWidth;
        bars[index].style.left = `${leftPos - 5}px`;
      });
    };

    const updateBarHeight = () => {
      const tableHeight = table.offsetHeight;
      bars.forEach(bar => {
        bar.style.height = `${tableHeight}px`;
      });
      adjustContainerHeight();
    };
    updateBarHeight();

    window.addEventListener('resize', () => {
      updateBarHeight();
      updateBarPositions();
      totalRow.style.width = `${table.offsetWidth}px`;
      adjustContainerHeight();
    });

    let isDraggingScroll = false;
    let startXScroll;
    let scrollLeft;
    let animationFrameId;

    const smoothScroll = (targetScroll) => {
      const currentScroll = container.scrollLeft;
      const delta = targetScroll - currentScroll;
      const step = delta * 0.05;
      container.scrollLeft += step;
      if (Math.abs(delta) > 0.5) {
        animationFrameId = requestAnimationFrame(() => smoothScroll(targetScroll));
      } else {
        container.scrollLeft = targetScroll;
        cancelAnimationFrame(animationFrameId);
      }
    };

    container.addEventListener('mousedown', (e) => {
      // Check if the target is a resize bar or within a shipmentTableTd cell
      if (!e.target.classList.contains('resize-bar') && !e.target.closest('.shipmentTableTd')) {
        isDraggingScroll = true;
        startXScroll = e.pageX;
        scrollLeft = container.scrollLeft;
        container.style.cursor = 'grabbing';
        container.style.userSelect = 'none';
      }
    });

    container.addEventListener('mousemove', (e) => {
      if (isDraggingScroll) {
        const x = e.pageX;
        const walk = (startXScroll - x);
        const targetScroll = scrollLeft + walk;
        cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(() => smoothScroll(targetScroll));
      }
    });

    container.addEventListener('mouseup', () => {
      isDraggingScroll = false;
      container.style.cursor = 'default';
      container.style.userSelect = 'auto';
      cancelAnimationFrame(animationFrameId);
    });

    container.addEventListener('mouseleave', () => {
      isDraggingScroll = false;
      container.style.cursor = 'default';
      container.style.userSelect = 'auto';
      cancelAnimationFrame(animationFrameId);
    });

    container.addEventListener('wheel', (e) => {
      if (Math.abs(e.deltaX) > 0) {
        container.scrollLeft += e.deltaX;
        e.preventDefault();
      }
    });

    const pageSelect = document.getElementById('pageSelect');
    if (pageSelect) {
      pageSelect.addEventListener('change', (e) => {
        const selectedPage = e.target.value;
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        params.set('page', selectedPage);
        url.search = params.toString();
        window.location.href = url.toString();
      });
    }

    const resizeObserver = new ResizeObserver(() => {
      updateBarHeight();
      updateBarPositions();
      totalRow.style.width = `${table.offsetWidth}px`;
      adjustContainerHeight();
    });
    resizeObserver.observe(table);

    const imagesAndIcons = container.querySelectorAll('img, i.pdf-icon, .modal-image, .modal-pdf');
    imagesAndIcons.forEach(element => {
      element.addEventListener('dragstart', (e) => e.preventDefault());
    });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
